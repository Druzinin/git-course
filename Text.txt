CREATE DATABASE gruber;
USE gruber;

CREATE TABLE salespeople (
  snum INT(8) PRIMARY KEY,
  sname VARCHAR(50),
  city VARCHAR(50),
  comm DECIMAL(5, 2)
);

CREATE TABLE customers (
  cnum INT(8) PRIMARY KEY,
  cname VARCHAR(50),
  pol VARCHAR(50),
  city VARCHAR(50),
  rating INT,
  snum INT,
  FOREIGN KEY (snum) REFERENCES
  salespeople(snum)
);

CREATE TABLE orders (
  onum INT(8) PRIMARY KEY,
  amt DECIMAL(8, 2),
  odate DATE,
  cnum INT,
  snum INT,
  FOREIGN KEY (cnum) REFERENCES customers(cnum),
  FOREIGN KEY (snum) REFERENCES salespeople(snum)
);



INSERT INTO salespeople (snum, sname, city, comm)
VALUES
    (1001, 'Peel', 'London', 0.12),
    (1002, 'Serres', 'San Jose', 0.13),
    (1004, 'Motika', 'London', 0.11),
    (1007, 'Rifkin', 'Barcelona', 0.15),
    (1003, 'Axelrod', 'New York', 0.10);

INSERT INTO customers (cnum, cname, pol, city, rating, snum)
VALUES
    (2001, 'Hoffman', 'ж', 'London', 100, 1001),
    (2002, 'Giovanni', 'ж', 'Rome', 200, 1003),
    (2003, 'Liu', 'м', 'San Jose', 200, 1002),
    (2004, 'Grass', 'м', 'Berlin', 300, 1002),
    (2006, 'Clemens', 'ж', 'London', 100, 1001),
    (2008, 'Cisneros', 'ж', 'San Jose', 300, 1007),
    (2007, 'Pereira', 'м', 'Rome', 100, 1004);

INSERT INTO orders (onum, amt, odate, cnum, snum)
VALUES
    (3001, 18.69, '2021-03-10', 2008, 1007),
    (3003, 767.19, '2021-03-10', 2001, 1001),
    (3002, 1900.10, '2021-03-10', 2007, 1004),
    (3005, 5160.45, '2021-03-10', 2003, 1002),
    (3006, 1098.16, '2021-03-10', 2008, 1007),
    (3009, 1713.23, '2021-04-10', 2002, 1003),
    (3007, 75.75, '2021-04-10', 2004, 1002),
    (3008, 4723.00, '2021-05-10', 2006, 1001),
    (3010, 1309.95, '2021-06-10', 2004, 1002),
    (3011, 9891.88, '2021-06-10', 2006, 1001);


7.
CREATE VIEW 7_1 AS SELECT DISTINCT city FROM customers;
CREATE VIEW 7_2 AS SELECT DISTINCT rating FROM customers;
CREATE VIEW 7_3 AS SELECT DISTINCT comm FROM salespeople;
CREATE VIEW 7_4 AS SELECT * FROM salespeople WHERE city = 'London';
CREATE VIEW 7_5 AS SELECT * FROM salespeople WHERE comm > 0.12;
CREATE VIEW 7_6 AS SELECT * FROM customers WHERE city = 'Rome';
CREATE VIEW 7_7 AS SELECT * FROM customers WHERE rating IN (100, 300);
CREATE VIEW 7_8 AS SELECT * FROM orders WHERE amt < 1000;
CREATE VIEW 7_9 AS SELECT * FROM customers WHERE city = 'Rome' AND rating = 200;
CREATE VIEW 7_10 AS SELECT * FROM customers WHERE city = 'Berlin' OR rating = 300;

CREATE VIEW 7_11 AS SELECT * FROM customers WHERE snum IN (1001, 1002, 1007);
CREATE VIEW 7_12 AS SELECT * FROM orders WHERE cnum IN (2001, 2004, 2008);
CREATE VIEW 7_13 AS SELECT * FROM salespeople WHERE snum BETWEEN 1001 AND 1005;
CREATE VIEW 7_14 AS SELECT * FROM salespeople WHERE comm BETWEEN 0.1 AND 0.13;
CREATE VIEW 7_15 AS SELECT * FROM customers WHERE cname BETWEEN 'A' AND 'H';
CREATE VIEW 7_16 AS SELECT * FROM customers WHERE city BETWEEN 'A' AND 'H';
CREATE VIEW 7_17 AS SELECT * FROM orders WHERE odate BETWEEN '2021-03-10' AND '2021-05-11';
CREATE VIEW 7_18 AS SELECT * FROM customers WHERE cname LIKE 'C%';
CREATE VIEW 7_19 AS SELECT * FROM customers WHERE cname LIKE 'G%';
CREATE VIEW 7_20 AS SELECT * FROM customers WHERE cname LIKE 'G%s';


8.
CREATE VIEW 8_1 AS SELECT COUNT(*) AS "Количество продавцов" FROM salespeople;
CREATE VIEW 8_2 AS SELECT COUNT(DISTINCT city) AS "Города продавцов" FROM salespeople;
CREATE VIEW 8_3 AS SELECT COUNT() AS "Количество строк" FROM customers;
CREATE VIEW 8_4 AS SELECT SUM(rating) AS "Общий рейтинг заказчиков" FROM customers;
CREATE VIEW 8_5 AS SELECT SUM(amt) AS "Сумма заказов" FROM orders;
CREATE VIEW 8_6 AS SELECT AVG(rating) AS "Средний рейтинг заказчиков" FROM customers;
CREATE VIEW 8_7 AS SELECT AVG(amt) AS "Средняя стоимость заказа" FROM orders;
CREATE VIEW 8_8 AS SELECT MIN(rating) AS Минимальный рейтинг заказчика FROM customers;
CREATE VIEW 8_9 AS SELECT MAX(comm) AS Максимальная комиссия продавца FROM salespeople;
CREATE VIEW 8_10 AS SELECT SUM(amt) + 100 AS Общая стоимость заказа FROM orders;
CREATE VIEW 8_11 AS SELECT cname AS Имя, city AS Город, rating / 50 AS Рейтинг FROM customers;
CREATE VIEW 8_12 AS SELECT sname AS Имя, city AS Город, SIN(comm)  10 AS Комиссионные FROM salespeople;
CREATE VIEW 8_13 AS SELECT 'Поле cnum - это номер заказчика. Имя заказчика и город также представлены в таблице.' AS 'Описание' FROM customers LIMIT 1;
CREATE VIEW 8_14 AS SELECT 'Поле snum - это номер продавца. Имя продавца и город также представлены в таблице.' AS 'Описание snum',
       'Поле comm - это комиссионные продавца.' AS 'Описание comm' FROM salespeople LIMIT 1;


9.
CREATE VIEW num_cities AS
SELECT COUNT(DISTINCT city) AS num_cities FROM customers WHERE city IS NOT NULL;

CREATE VIEW min_order_amt AS
SELECT customers.cname, MIN(orders.amt) AS min_order_amt FROM customers
JOIN orders ON customers.cnum = orders.cnum GROUP BY customers.cnum;

CREATE VIEW min_order_amt_by_seller_and_date AS
SELECT orders.snum, orders.odate, MIN(orders.amt) AS min_order_amt FROM orders GROUP BY orders.snum, orders.odate;

CREATE VIEW min_order_amt_for_customers AS
SELECT customers.cname, MIN(orders.amt) AS min_order_amt FROM customers
JOIN orders ON customers.cnum = orders.cnum
WHERE customers.cname IN ('Cisneros', 'Grass', 'Clemens') GROUP BY customers.cnum;

CREATE VIEW customers_starting_with_G AS
SELECT cname FROM customers WHERE cname LIKE 'G%' ORDER BY cname ASC;

CREATE VIEW max_rating_per_city AS
SELECT city, MAX(rating) AS max_rating FROM customers GROUP BY city;

CREATE VIEW num_sellers_registering_orders_per_day AS
SELECT orders.odate, COUNT(DISTINCT orders.snum) AS num_salespeople FROM orders GROUP BY orders.odate;

CREATE VIEW num_orders_per_seller_and_day AS
SELECT orders.odate, orders.snum, COUNT(*) AS num_orders FROM orders GROUP BY orders.odate, orders.snum;


CREATE VIEW customer_ratings AS
SELECT cname, rating FROM customers
ORDER BY rating;

CREATE VIEW salespeople_customers AS
SELECT salespeople.sname, customers.cname FROM salespeople
JOIN orders ON salespeople.snum = orders.snum
JOIN customers c ON orders.cnum = customers.cnum
ORDER BY salespeople.sname;

CREATE VIEW salespeople_desc AS
SELECT snum, sname, city FROM salespeople
ORDER BY sname DESC;

CREATE VIEW customers_asc AS
SELECT cname, city, rating FROM customers
ORDER BY rating, cname;

CREATE VIEW salespeople_by_city AS
SELECT sname, city FROM salespeople
GROUP BY city
ORDER BY sname;

CREATE VIEW customers_grouped AS
SELECT cname, city, rating FROM customers
GROUP BY city
ORDER BY city;

CREATE VIEW city_ratings_count AS
SELECT city, COUNT(rating) AS rating_count FROM customers
GROUP BY city
ORDER BY rating_count ASC;


10.
CREATE VIEW sales_between_700_and_2000 AS
SELECT salespeople.sname AS salesperson_name, customers.cname AS customer_name, orders.amt AS purchase_amount
FROM salespeople JOIN customers ON salespeople.snum = customers.snum JOIN orders ON customers.cnum = orders.cnum
WHERE orders.amt BETWEEN 700 AND 2000;

CREATE VIEW sales_without_commission AS
SELECT salespeople.sname AS salesperson_name, SUM(orders.amt) AS purchase_amount FROM salespeople
JOIN customers ON salespeople.snum = customers.snum JOIN orders ON customers.cnum = orders.cnum
WHERE salespeople.comm = 0 GROUP BY salespeople.sname;

CREATE VIEW sales_customers AS
SELECT salespeople.sname AS salesperson_name, customers.cname AS customer_name FROM salespeople
JOIN customers ON salespeople.snum = customers.snum;

CREATE VIEW sales_customers_same_city AS
SELECT salespeople.sname AS salesperson_name, customers.cname AS customer_name, customers.city AS customer_city
FROM salespeople JOIN customers ON salespeople.snum = customers.snum
JOIN customers2 ON c2.cnum <> customers.cnum AND c2.snum = salespeople.snum AND c2.city = customers.city;

CREATE VIEW sales_less_than_12_percent AS
SELECT orders.odate AS order_date, salespeople.comm AS salesperson_commission FROM salespeople
JOIN customers ON salespeople.snum = customers.snum JOIN orders ON customers.cnum = orders.cnum
WHERE salespeople.comm < 0.12;

CREATE VIEW CustomersOrdersSumByRating AS
SELECT customers.cname AS 'Имя покупателя', orders.amt AS 'Сумма заказа', customers.rating AS 'Рейтинг'
FROM customers JOIN orders ON customers.cnum = orders.cnum WHERE customers.rating > 100;

CREATE VIEW CustomersByOrderDate AS
SELECT customers.cname AS 'Имя заказчика', orders.odate AS 'Дата заказа' FROM customers
JOIN orders ON customers.cnum = orders.cnum WHERE orders.odate = '2021-03-10';

CREATE VIEW CustomersOrdersSalespeopleByDate AS
SELECT customers.cname AS 'Имя покупателя', orders.amt AS 'Сумма заказа', salespeople.comm
AS 'Комиссионные продавца', orders.odate AS 'Дата заказа' FROM customers JOIN orders ON customers.cnum = orders.cnum
JOIN salespeople ON orders.snum = salespeople.snum WHERE orders.odate = '2021-04-10';

CREATE VIEW CustomersRatingOrdersSumByDate AS
SELECT customers.cname AS 'Имя заказчика', customers.rating AS 'Рейтинг', orders.amt AS 'Сумма заказа', orders.odate
AS 'Дата заказа' FROM customers JOIN orders ON customers.cnum = orders.cnum
WHERE orders.odate = '2021-03-10' AND orders.amt > 3000;

CREATE VIEW OrdersCustomersSalespeopleByCity AS
SELECT orders.onum AS 'Номер заказа', customers.cname AS 'Имя заказчика', salespeople.sname
AS 'Имя продавца', customers.city AS 'Название города' FROM orders JOIN customers ON orders.cnum = customers.cnum
JOIN salespeople ON orders.snum = salespeople.snum
WHERE customers.city = 'San Jose' AND salespeople.city = 'San Jose';
